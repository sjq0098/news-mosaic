å½“ç„¶å¯ä»¥ï¼ä¸‹é¢æ˜¯é’ˆå¯¹ **embeddingã€RAGã€å¡ç‰‡ç”Ÿæˆã€å›å¤ç”Ÿæˆ** å››å¤§æ ¸å¿ƒæ¨¡å—çš„è¯¦ç»†æ–‡æ¡£è‰ç¨¿ï¼Œé€‚åˆåˆå¹¶è¿› `/backend/docs/`ï¼Œä¹Ÿä¾¿äºå‰ç«¯å’Œå…¶ä»–åŒäº‹ç†è§£è°ƒç”¨ã€‚

---

# ğŸ“š Backend æ ¸å¿ƒåŠŸèƒ½æ¨¡å—æ–‡æ¡£

## 1. å‘é‡EmbeddingæœåŠ¡

### 1.1 åŠŸèƒ½ç®€ä»‹
- **ä½œç”¨**ï¼šå°†æ–°é—»æ–‡æœ¬ã€ç”¨æˆ·å¯¹è¯ç­‰å†…å®¹è½¬åŒ–ä¸ºé«˜ç»´å‘é‡ï¼Œä¾¿äºåç»­çš„ç›¸ä¼¼åº¦æ£€ç´¢å’Œè¯­ä¹‰åˆ†æã€‚
- **ä¸»è¦æ¥å£**ï¼š
  - `QWenEmbeddingService.get_embeddings(texts: List[str]) -> List[List[float]]`
    - è¾“å…¥ï¼šå­—ç¬¦ä¸²åˆ—è¡¨ï¼ˆå¦‚æ–°é—»æ­£æ–‡ã€ç”¨æˆ·é—®é¢˜ï¼‰
    - è¾“å‡ºï¼šæ¯æ¡æ–‡æœ¬å¯¹åº”çš„å‘é‡ï¼ˆfloatåˆ—è¡¨ï¼‰

### 1.2 å…¸å‹ç”¨æ³•
```python
from services.embedding_service import QWenEmbeddingService

embedding_service = QWenEmbeddingService()
vectors = await embedding_service.get_embeddings(["äººå·¥æ™ºèƒ½å‘å±•è¶‹åŠ¿", "æ–°èƒ½æºæ±½è½¦å¸‚åœº"])
```

### 1.3 è¯´æ˜
- æ”¯æŒæ‰¹é‡æ–‡æœ¬embedding
- å‘é‡ç»´åº¦ä¸åº•å±‚æ¨¡å‹ä¸€è‡´ï¼ˆå¦‚768/1024ç­‰ï¼‰
- ä¸»è¦ç”¨äºæ–°é—»å…¥åº“ã€RAGæ£€ç´¢ã€ç”¨æˆ·è®°å¿†ç­‰åœºæ™¯

---

## 2. RAGï¼ˆRetrieval-Augmented Generationï¼‰æ£€ç´¢å¢å¼ºç”Ÿæˆ

### 2.1 åŠŸèƒ½ç®€ä»‹
- **ä½œç”¨**ï¼šç»“åˆå‘é‡æ£€ç´¢å’Œå¤§æ¨¡å‹ç”Ÿæˆï¼Œå®ç°â€œå…ˆæŸ¥å†ç­”â€çš„æ™ºèƒ½é—®ç­”/åˆ†æ
- **ä¸»è¦æ¥å£**ï¼š
  - `IntegratedRAGService.search_relevant_news(query: str, top_k: int = 3) -> List[Dict]`
    - è¾“å…¥ï¼šç”¨æˆ·æŸ¥è¯¢
    - è¾“å‡ºï¼šæœ€ç›¸å…³çš„æ–°é—»åˆ—è¡¨ï¼ˆå«æ ‡é¢˜ã€å†…å®¹ã€ç›¸ä¼¼åº¦ç­‰ï¼‰
  - `IntegratedRAGService.chat_with_news_context(user_query: str, max_context_news: int = 3) -> Dict`
    - è¾“å…¥ï¼šç”¨æˆ·é—®é¢˜
    - è¾“å‡ºï¼šAIå›å¤ã€å‚è€ƒæ–°é—»ã€å¡ç‰‡ç­‰ç»“æ„åŒ–ç»“æœ

### 2.2 å…¸å‹ç”¨æ³•
```python
from services.integrated_rag_service import IntegratedRAGService

rag_service = IntegratedRAGService()
news_list = await rag_service.search_relevant_news("AIèŠ¯ç‰‡çªç ´", top_k=5)
result = await rag_service.chat_with_news_context("æœ€è¿‘AIé¢†åŸŸæœ‰ä»€ä¹ˆé‡å¤§çªç ´ï¼Ÿ")
print(result["ai_response"])
print(result["relevant_news"])
```

### 2.3 è¯´æ˜
- æ£€ç´¢éƒ¨åˆ†åŸºäºembeddingç›¸ä¼¼åº¦ï¼Œæ”¯æŒå¤šæ¡æ–°é—»å¬å›
- ç”Ÿæˆéƒ¨åˆ†è°ƒç”¨QWENç­‰å¤§æ¨¡å‹ï¼Œç»“åˆæ–°é—»ä¸Šä¸‹æ–‡ç”Ÿæˆä¸“ä¸šå›å¤
- è¿”å›ç»“æ„åŒ…å«AIå›å¤ã€ç›¸å…³æ–°é—»ã€å¡ç‰‡æ‘˜è¦ã€tokenç”¨é‡ç­‰

---

## 3. æ–°é—»å¡ç‰‡ç”Ÿæˆ

### 3.1 åŠŸèƒ½ç®€ä»‹
- **ä½œç”¨**ï¼šå°†æ–°é—»å†…å®¹ç»“æ„åŒ–ä¸ºâ€œå¡ç‰‡â€ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºå’Œå¤šç»´åº¦åˆ†æ
- **ä¸»è¦æ¥å£**ï¼š
  - `RAGEnhancedCardService.generate_news_card(news_data: Dict) -> NewsCardResponse`
    - è¾“å…¥ï¼šå•æ¡æ–°é—»æ•°æ®
    - è¾“å‡ºï¼šå¡ç‰‡å¯¹è±¡ï¼ˆå«æ‘˜è¦ã€æƒ…æ„Ÿã€ä¸»é¢˜ã€é‡è¦æ€§ç­‰ï¼‰

### 3.2 å…¸å‹ç”¨æ³•
```python
from services.rag_enhanced_card_service import RAGEnhancedCardService

card_service = RAGEnhancedCardService()
news = {...}  # ä¸€æ¡æ–°é—»å­—å…¸
card = await card_service.generate_news_card(news)
print(card.card.metadata.summary)
print(card.card.metadata.sentiment_label)
```

### 3.3 è¯´æ˜
- æ”¯æŒæ‘˜è¦ã€æƒ…æ„Ÿã€ä¸»é¢˜ã€å…³é”®è¯ã€é‡è¦æ€§ç­‰å¤šç»´åº¦ç»“æ„åŒ–
- å¯æ‰©å±•æ”¯æŒå®ä½“è¯†åˆ«ã€æ—¶é—´æ€§ã€å¯ä¿¡åº¦ç­‰
- é€‚åˆå‰ç«¯å¡ç‰‡å¼å±•ç¤ºã€ä¸“é¢˜èšåˆç­‰åœºæ™¯

---

## 4. æ™ºèƒ½å›å¤ç”Ÿæˆ

### 4.1 åŠŸèƒ½ç®€ä»‹
- **ä½œç”¨**ï¼šæ ¹æ®ç”¨æˆ·é—®é¢˜å’Œæ–°é—»ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¸“ä¸šã€ä¸ªæ€§åŒ–çš„AIå›å¤
- **ä¸»è¦æ¥å£**ï¼š
  - `EnhancedChatService.chat_with_enhanced_context(request: EnhancedChatRequest) -> EnhancedChatResponse`
    - è¾“å…¥ï¼šå¢å¼ºå¯¹è¯è¯·æ±‚ï¼ˆå«ç”¨æˆ·IDã€ä¼šè¯IDã€æ¶ˆæ¯ã€æ˜¯å¦ç”¨è®°å¿†ç­‰ï¼‰
    - è¾“å‡ºï¼šå¢å¼ºå¯¹è¯å“åº”ï¼ˆå«AIå›å¤ã€ç½®ä¿¡åº¦ã€ä¸Šä¸‹æ–‡æ‘˜è¦ç­‰ï¼‰

### 4.2 å…¸å‹ç”¨æ³•
```python
from services.enhanced_chat_service import EnhancedChatService, EnhancedChatRequest

chat_service = EnhancedChatService()
request = EnhancedChatRequest(
    user_id="user_001",
    session_id="session_001",
    message="æ–°èƒ½æºæ±½è½¦å¸‚åœºè¡¨ç°å¦‚ä½•ï¼Ÿ",
    include_memory=True
)
response = await chat_service.chat_with_enhanced_context(request)
print(response.response)
print(response.context_summary)
```

### 4.3 è¯´æ˜
- æ”¯æŒå¤šè½®å¯¹è¯ã€ä¸Šä¸‹æ–‡è®°å¿†ã€ä¸ªæ€§åŒ–é£æ ¼
- å¯ç»“åˆRAGæ£€ç´¢ç»“æœã€ç”¨æˆ·åå¥½ç­‰ç”Ÿæˆæ›´è´´åˆéœ€æ±‚çš„å›å¤
- è¿”å›ç»“æ„ä¸°å¯Œï¼Œä¾¿äºå‰ç«¯å±•ç¤ºå’Œåç»­åˆ†æ

---

## 5. ç»Ÿä¸€Pipelineè°ƒç”¨å»ºè®®

### 5.1 æ¨èAPI
- `/api/v1/pipeline/complete`ï¼šæœ€å…¨åŠŸèƒ½ï¼Œé€‚åˆç«¯åˆ°ç«¯è°ƒç”¨
- `/api/v1/pipeline/simple`ï¼šç®€åŒ–å‚æ•°ï¼Œé€‚åˆå¸¸è§„å¯¹è¯
- `/api/v1/pipeline/news`ï¼šä¸“æ³¨æ–°é—»åˆ†æå’Œå¡ç‰‡ç”Ÿæˆ

### 5.2 å…¸å‹å‰ç«¯è°ƒç”¨æµç¨‹
1. ç”¨æˆ·è¾“å…¥é—®é¢˜
2. å‰ç«¯è°ƒç”¨ `/api/v1/pipeline/complete` æˆ– `/api/v1/pipeline/simple`
3. åç«¯è‡ªåŠ¨å®Œæˆ embeddingã€RAG æ£€ç´¢ã€å¡ç‰‡ç”Ÿæˆã€AIå›å¤
4. å‰ç«¯è§£æè¿”å›ç»“æ„ï¼Œå±•ç¤ºå¡ç‰‡ã€AIå›å¤ã€ç›¸å…³æ–°é—»ç­‰

---

## 6. FAQ

- **Q: å¦‚ä½•è‡ªå®šä¹‰å¡ç‰‡å†…å®¹ï¼Ÿ**  
  A: å¯åœ¨ `generate_news_card` æ—¶ä¼ å…¥ä¸åŒå‚æ•°ï¼Œæˆ–æ‰©å±•å¡ç‰‡å…ƒæ•°æ®ç»“æ„ã€‚

- **Q: å¦‚ä½•åªç”¨RAGæ£€ç´¢ä¸ç”Ÿæˆå¡ç‰‡ï¼Ÿ**  
  A: è°ƒç”¨ `IntegratedRAGService.search_relevant_news` æˆ– `/api/v1/pipeline/news`ï¼Œå‚æ•° `generate_cards=False`ã€‚

- **Q: å¦‚ä½•è·å–embeddingå‘é‡ï¼Ÿ**  
  A: ç›´æ¥è°ƒç”¨ `QWenEmbeddingService.get_embeddings`ï¼Œæ”¯æŒæ‰¹é‡æ–‡æœ¬ã€‚

---

å…·ä½“å‡½æ•°å’Œæ–‡ä»¶è§£æï¼š


---

## 1. å‘é‡Embedding

### 1.1 æ–‡ä»¶
- `backend/services/embedding_service.py`

### 1.2 ä¸»è¦ç±»ä¸å‡½æ•°

#### `class QWenEmbeddingService`

##### `async def get_embeddings(self, texts: List[str]) -> List[List[float]]`
- **åŠŸèƒ½**ï¼šå°†ä¸€ç»„æ–‡æœ¬è½¬ä¸ºå‘é‡
- **å‚æ•°**ï¼š
  - `texts`ï¼š`List[str]`ï¼Œå¾…ç¼–ç çš„æ–‡æœ¬åˆ—è¡¨
- **è¿”å›**ï¼š
  - `List[List[float]]`ï¼Œæ¯æ¡æ–‡æœ¬çš„å‘é‡
- **ç¤ºä¾‹**ï¼š
  ```python
  from services.embedding_service import QWenEmbeddingService
  embedding_service = QWenEmbeddingService()
  vectors = await embedding_service.get_embeddings(["æ–°é—»1å†…å®¹", "æ–°é—»2å†…å®¹"])
  ```

---

## 2. RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ

### 2.1 æ–‡ä»¶
- `backend/services/integrated_rag_service.py`

### 2.2 ä¸»è¦ç±»ä¸å‡½æ•°

#### `class IntegratedRAGService`

##### `async def search_relevant_news(self, query: str, top_k: int = 3) -> List[Dict]`
- **åŠŸèƒ½**ï¼šæ ¹æ®queryè¯­ä¹‰æ£€ç´¢æœ€ç›¸å…³çš„æ–°é—»
- **å‚æ•°**ï¼š
  - `query`ï¼š`str`ï¼Œç”¨æˆ·é—®é¢˜
  - `top_k`ï¼š`int`ï¼Œè¿”å›æ–°é—»æ¡æ•°
- **è¿”å›**ï¼š
  - `List[Dict]`ï¼Œæ¯æ¡æ–°é—»åŒ…å«`title`ã€`content`ã€`similarity_score`ç­‰
- **ç¤ºä¾‹**ï¼š
  ```python
  rag_service = IntegratedRAGService()
  news_list = await rag_service.search_relevant_news("AIèŠ¯ç‰‡çªç ´", top_k=5)
  ```

##### `async def chat_with_news_context(self, user_query: str, max_context_news: int = 3) -> Dict`
- **åŠŸèƒ½**ï¼šRAGç«¯åˆ°ç«¯ï¼Œæ£€ç´¢+ç”ŸæˆAIå›å¤+å¡ç‰‡
- **å‚æ•°**ï¼š
  - `user_query`ï¼š`str`ï¼Œç”¨æˆ·é—®é¢˜
  - `max_context_news`ï¼š`int`ï¼Œä¸Šä¸‹æ–‡æ–°é—»æ¡æ•°
- **è¿”å›**ï¼š
  - `Dict`ï¼Œç»“æ„å¦‚ä¸‹ï¼š
    ```python
    {
      "user_query": "åŸå§‹é—®é¢˜",
      "ai_response": "AIç”Ÿæˆçš„å›å¤",
      "relevant_news": [  # ç»“æ„åŒ–æ–°é—»
        {"title": "...", "source": "...", "similarity": 0.9, "category": "...", "url": "..."}
      ],
      "news_card": {  # ç»“æ„åŒ–å¡ç‰‡
        "card_id": "...",
        "summary": "...",
        "importance_level": "...",
        "sentiment_label": "...",
        "generation_time": 1.23
      },
      "tokens_used": 123,
      "generation_time": 1.23,
      "processing_time": 2.34
    }
    ```
- **ç¤ºä¾‹**ï¼š
  ```python
  result = await rag_service.chat_with_news_context("æœ€è¿‘AIé¢†åŸŸæœ‰ä»€ä¹ˆé‡å¤§çªç ´ï¼Ÿ")
  print(result["ai_response"])
  print(result["relevant_news"])
  print(result["news_card"])
  ```

---

## 3. æ–°é—»å¡ç‰‡ç”Ÿæˆ

### 3.1 æ–‡ä»¶
- `backend/services/rag_enhanced_card_service.py`

### 3.2 ä¸»è¦ç±»ä¸å‡½æ•°

#### `class RAGEnhancedCardService`

##### `async def generate_news_card(self, news_data: Dict) -> NewsCardResponse`
- **åŠŸèƒ½**ï¼šå°†ä¸€æ¡æ–°é—»ç»“æ„åŒ–ä¸ºå¡ç‰‡
- **å‚æ•°**ï¼š
  - `news_data`ï¼š`Dict`ï¼Œå•æ¡æ–°é—»ï¼ˆéœ€åŒ…å«`title`ã€`content`ç­‰å­—æ®µï¼‰
- **è¿”å›**ï¼š
  - `NewsCardResponse`ï¼Œå…¶ `.card.metadata` åŒ…å«ï¼š
    - `summary`ï¼šæ‘˜è¦
    - `sentiment_label`ï¼šæƒ…æ„Ÿ
    - `importance_level`ï¼šé‡è¦æ€§
    - `keywords`ã€`entities` ç­‰
- **ç¤ºä¾‹**ï¼š
  ```python
  from services.rag_enhanced_card_service import RAGEnhancedCardService
  card_service = RAGEnhancedCardService()
  card = await card_service.generate_news_card(news)
  print(card.card.metadata.summary)
  print(card.card.metadata.sentiment_label)
  ```

---

## 4. æ™ºèƒ½å›å¤ç”Ÿæˆï¼ˆå¢å¼ºå¯¹è¯ï¼‰

### 4.1 æ–‡ä»¶
- `backend/services/enhanced_chat_service.py`

### 4.2 ä¸»è¦ç±»ä¸å‡½æ•°

#### `class EnhancedChatService`

##### `async def chat_with_enhanced_context(self, request: EnhancedChatRequest) -> EnhancedChatResponse`
- **åŠŸèƒ½**ï¼šç»“åˆç”¨æˆ·è®°å¿†ã€ä¸Šä¸‹æ–‡ã€RAGç­‰ç”Ÿæˆä¸ªæ€§åŒ–AIå›å¤
- **å‚æ•°**ï¼š
  - `request`ï¼š`EnhancedChatRequest`ï¼Œå­—æ®µåŒ…æ‹¬ï¼š
    - `user_id`ï¼š`str`
    - `session_id`ï¼š`str`
    - `message`ï¼š`str`
    - `include_memory`ï¼š`bool`
    - `include_rag`ï¼š`bool`
    - `include_news_card`ï¼š`bool`
    - `response_style`ï¼š`Optional[str]`
    - `max_context_memories`ï¼š`int`
- **è¿”å›**ï¼š
  - `EnhancedChatResponse`ï¼Œå­—æ®µåŒ…æ‹¬ï¼š
    - `response`ï¼šAIå›å¤å†…å®¹
    - `confidence_score`ï¼šç½®ä¿¡åº¦
    - `context_summary`ï¼šä¸Šä¸‹æ–‡æ‘˜è¦
    - `used_memories_count`ï¼šç”¨åˆ°çš„è®°å¿†æ•°
    - `used_news_count`ï¼šç”¨åˆ°çš„æ–°é—»æ•°
    - `suggested_topics`ï¼šæ¨èè¯é¢˜
    - `related_news`ï¼šç›¸å…³æ–°é—»
- **ç¤ºä¾‹**ï¼š
  ```python
  from services.enhanced_chat_service import EnhancedChatService, EnhancedChatRequest
  chat_service = EnhancedChatService()
  req = EnhancedChatRequest(
      user_id="user_001",
      session_id="session_001",
      message="æ–°èƒ½æºæ±½è½¦å¸‚åœºè¡¨ç°å¦‚ä½•ï¼Ÿ",
      include_memory=True
  )
  resp = await chat_service.chat_with_enhanced_context(req)
  print(resp.response)
  print(resp.context_summary)
  ```

---

## 5. ç»Ÿä¸€Pipelineæ¥å£ï¼ˆAPIå¯¹æ¥æ¨èï¼‰

### 5.1 æ–‡ä»¶
- `backend/api/pipeline.py`
- `backend/services/complete_pipeline_service.py`

### 5.2 æ¨èAPIç«¯ç‚¹

#### `/api/v1/pipeline/complete` ï¼ˆPOSTï¼‰
- **åŠŸèƒ½**ï¼šç«¯åˆ°ç«¯ï¼Œè‡ªåŠ¨å®Œæˆ embeddingã€RAGã€å¡ç‰‡ã€AIå›å¤
- **è¯·æ±‚ä½“**ï¼ˆ`PipelineRequest`ï¼‰ï¼š
  - `user_id`ã€`session_id`ã€`message`ã€`mode`ã€`enable_memory`ã€`enable_rag`ã€`enable_cards`ã€`enable_personalization`ã€`max_results`ã€`card_count`ã€`similarity_threshold` ç­‰
- **è¿”å›ä½“**ï¼ˆ`PipelineResponse`ï¼‰ï¼š
  - `ai_response`ï¼šAIå›å¤
  - `retrieved_news`ï¼šç›¸å…³æ–°é—»
  - `generated_cards`ï¼šå¡ç‰‡
  - `suggested_questions`ï¼šæ¨èé—®é¢˜
  - `performance_metrics`ã€`quality_scores` ç­‰

#### `/api/v1/pipeline/simple` ï¼ˆPOSTï¼‰
- **åŠŸèƒ½**ï¼šç®€åŒ–å‚æ•°ï¼Œé€‚åˆå¸¸è§„å¯¹è¯

#### `/api/v1/pipeline/news` ï¼ˆPOSTï¼‰
- **åŠŸèƒ½**ï¼šä¸“æ³¨æ–°é—»åˆ†æå’Œå¡ç‰‡ç”Ÿæˆ

### 5.3 ç«¯åˆ°ç«¯è°ƒç”¨æµç¨‹
1. å‰ç«¯æ”¶é›†ç”¨æˆ·è¾“å…¥
2. ç»„è£…è¯·æ±‚ä½“ï¼ŒPOSTåˆ° `/api/v1/pipeline/complete`
3. åç«¯è‡ªåŠ¨ä¸²è” embeddingã€RAGã€å¡ç‰‡ã€AIå›å¤
4. å‰ç«¯è§£æ `ai_response`ã€`retrieved_news`ã€`generated_cards` ç­‰å­—æ®µå±•ç¤º

---

## 6. å…¸å‹è¿”å›JSONç»“æ„ç¤ºä¾‹

```json
{
  "ai_response": "æ–°èƒ½æºæ±½è½¦å¸‚åœºè¡¨ç°å¼ºåŠ²ï¼Œ...",
  "retrieved_news": [
    {"title": "2024å¹´æ–°èƒ½æºæ±½è½¦é”€é‡åˆ›æ–°é«˜", "source": "æ±½è½¦ä¹‹å®¶", "similarity": 0.92, "category": "æ±½è½¦", "url": "..."}
  ],
  "generated_cards": [
    {
      "card_id": "card_001",
      "summary": "2024å¹´æ–°èƒ½æºæ±½è½¦é”€é‡åŒæ¯”å¢é•¿42%...",
      "sentiment_label": "positive",
      "importance_level": "high"
    }
  ],
  "suggested_questions": [
    "æ–°èƒ½æºæ±½è½¦æœªæ¥è¿˜æœ‰å“ªäº›æŠ€æœ¯çªç ´ï¼Ÿ",
    "ç›¸å…³çš„å…¶ä»–æ–°é—»æœ‰å“ªäº›ï¼Ÿ"
  ],
  "performance_metrics": {"total_time": 1.23},
  "quality_scores": {"overall": 0.85}
}
```

---

## 7. å‚è€ƒæ–‡ä»¶ç»“æ„

- `services/embedding_service.py`ï¼šå‘é‡åŒ–
- `services/integrated_rag_service.py`ï¼šRAGæ£€ç´¢+ç”Ÿæˆ
- `services/rag_enhanced_card_service.py`ï¼šå¡ç‰‡ç”Ÿæˆ
- `services/enhanced_chat_service.py`ï¼šæ™ºèƒ½å›å¤
- `services/complete_pipeline_service.py`ï¼šç»Ÿä¸€è°ƒåº¦
- `api/pipeline.py`ï¼šAPIè·¯ç”±

---
